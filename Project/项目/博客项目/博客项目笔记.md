## 一、数据库设计

### 1. 设计表（用户7，文章9，评论5）

```sql
-- 创建⽤户表
create table userinfo(
	uid bigint auto_increment primary key comment '主键',
	loginname varchar(50) not null unique comment '登录⽤户	名',
	nickname varchar(50) default '' comment '昵称',
	`password` varchar(65) not null comment '密码',
	github varchar(255) comment 'github地址',
	photo varchar(255) comment '头像',
	`state` tinyint not null DEFAULT 1 comment '⽤户状态，1=正常|-1=异常|-2=永久冻结|-3=临时冻结'
);
insert into userinfo(loginname,`password`) values('admin','admin');

create table articleinfo(
	aid BIGINT auto_increment primary key comment '主键',
	`title` varchar(255) not null comment '标题',
	createtime TIMESTAMP not null default CURRENT_TIMESTAMP() comment '创建时间',
	updatetime TIMESTAMP not null DEFAULT CURRENT_TIMESTAMP() comment '修改时间',
	`desc` varchar(255) not null comment '⽂章简介',
	`content` longtext not null comment '⽂章正⽂',
	`state` TINYINT DEFAULT -1 comment '状态：-1=草稿|1=已发布',
	uid bigint not null comment '作者id',
	`rcount` bigint default 1 comment '阅读量'
);

-- 创建评论表
create table commentinfo(
	cid bigint auto_increment primary key comment '评论表的主键',
	aid bigint not null comment '⽂章表id',
	uid bigint not null comment '⽤户id',
	`content` varchar(500) not null comment '评论正⽂',
	createtime TIMESTAMP default CURRENT_TIMESTAMP() comment '评论的发表时间'
);

```
## 二、注册功能

传递参数：UserInfoVO，带有验证码

## 三、登录功能

传递参数：session

```java
// 5.如果输入密码和真实的密码相同，将用户对象存储到 Session
session.setAttribute(AppVar.SESSION_KEY_USERINFO, userInfo);
```

## 四、登录检验拦截器

### 1. LoginInterceptor

```java
package com.example.myblog.config;

/**
 * 登录判断的拦截器
 */
@Component
public class LoginInterceptor implements HandlerInterceptor {
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        // 1.先得到 HttpSession 对象
        HttpSession session = request.getSession(false);
        if(session!=null && session.getAttribute(AppVar.SESSION_KEY_USERINFO)!=null){
            // 已经登录
            return true;
        }
        // 代码执行到此处，说明用户未登录
        response.sendRedirect("/login.html");
        return false;
    }
}

```
### 2. MyConfig

```java
@Configuration
public class MyConfig implements WebMvcConfigurer {
    @Resource
    private LoginInterceptor loginInterceptor;
    @Value("${imagepath}")
    private String imagepath;

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(loginInterceptor)
                .addPathPatterns("/**") // 拦截所有请求
                .excludePathPatterns("/user/reg") // 排除注册接口（注册接口不拦截）
                .excludePathPatterns("/user/login")
                .excludePathPatterns("/user/getuser")
                .excludePathPatterns("/user/getsess")
                .excludePathPatterns("/user/isartbyme")
                .excludePathPatterns("/getcaptcha")
                .excludePathPatterns("/art/list")
                .excludePathPatterns("/art/detail")
                .excludePathPatterns("/art/update_rcount")
                .excludePathPatterns("/comment/list")
                .excludePathPatterns("/**/*.html")
                .excludePathPatterns("/css/**")
                .excludePathPatterns("/editor.md/**")
                .excludePathPatterns("/img/**")
                .excludePathPatterns("/image/**")
                .excludePathPatterns("/js/**");
    }
}
```
## 五、注销功能

```java
    @RequestMapping("/logout")
    public AjaxResult logout(HttpSession session) {
        try {
            // 清楚当前登录用户的 session 信息
            session.removeAttribute(AppVar.SESSION_KEY_USERINFO);
        } catch (Exception e) {
            return AjaxResult.fail(-1, "清楚失败");
        }
        return AjaxResult.succ(1);
    }
```
## 六、SessionUtil

```java
public class SessionUtil {

    /**
     * 获取当前登录用户的信息
     * @param session
     * @return
     */
    public static UserInfo getUserInfo(HttpServletRequest request){
        HttpSession session = request.getSession(false);
        if(session!=null && session.getAttribute(AppVar.SESSION_KEY_USERINFO)!=null){
            // 用户已登录
            return (UserInfo) session.getAttribute(AppVar.SESSION_KEY_USERINFO);
        }
        return null;
    }
}
```



## 七、文章添加功能



## 八、文章修改

## 九、文章分页功能

## 十、加盐算法

```java
package com.example.myblog.util;

import org.springframework.util.DigestUtils;
import org.springframework.util.StringUtils;

import java.util.UUID;

/**
 * 密码加盐操作
 */
public class PasswordUtil {

    /**
     * 加盐算法 -> 格式：盐值（32）$加密之后的密码（32）
     *
     * @param password 原密码
     * @return
     */
    public static String encrypt(String password) {
        // 1.生成盐值
        String salt = UUID.randomUUID().toString().replace("-", "");
        // 2.使用加密算法将盐值+原密码进行加密
        String finalPassword = DigestUtils.md5DigestAsHex((salt + password).getBytes());
        // 3.将盐值和加密后的密码一起返回
        String dbPassword = salt + "$" + finalPassword;
        return dbPassword;
    }

    /**
     * 密码验证
     *
     * @param inputPassword 用户输入的密码
     * @param dbPassword    数据库中的密码
     * @return
     */
    public static boolean decrypt(String inputPassword, String dbPassword) {
        // 1.验证参数
        if (!StringUtils.hasLength(inputPassword) || !StringUtils.hasLength(dbPassword) ||
                dbPassword.length() != 65 || !dbPassword.contains("$")) {
            return false;
        }
        // 2.将用户输入的密码和数据库的盐值进行加密，得到待验证的加密密码
        // 2.1 得到盐值 & 最终正确的密码
        String[] dbPasswordArray = dbPassword.split("\\$");
        String salt = dbPasswordArray[0];
        String finalPassword = dbPasswordArray[1];
        // 2.2 使用数据库的盐值+用户输入的密码进行加密=待验证的加密密码
        String userPassword = DigestUtils.md5DigestAsHex((salt + inputPassword).getBytes());
        // 3.将待验证密的加密密码和数据的加密的密码进行对比
        if (userPassword.equals(finalPassword)) {
            return true;
        }
        // 4.将结果返回给调用方
        return false;
    }

    public static void main(String[] args) {
        String password = "123456";
//        System.out.println("加盐加密的值："+encrypt(password));
//        System.out.println("加盐加密的值2："+encrypt(password));
//        System.out.println("加盐加密的值3："+encrypt(password));

        String inputPassword = "123456";
        String inputPassword2 = "456455";
        String dbPassword = "6d9104573c684c30ada25ec8ccdbb52d$5359762d43f9cd311a9fc2ea633abaec";

        System.out.println("正确的密码：" + decrypt(inputPassword, dbPassword));
        System.out.println("正确的密码：" + decrypt(inputPassword2, dbPassword));
    }
}
```
## 十一、登录信息保存到Redis



## 十二、验证码功能实现

> 1. CaptchaUti生成一个验证码
> 2. uuid生成一个验证码名称
> 3. 图形验证码写出到一个文件中lineCaptcha.write(imagepath+uuid+".png");
> 4. 构造验证码的url地址
> 5. 将验证码存储到redis（uuid-code）
> 6. 返回值是hashmap url+uuid

```java
@RestController
public class CaptchaController {

    @Value("${imagepath}")
    private String imagepath;
    @Autowired
    private RedisTemplate redisTemplate;

    @RequestMapping("/getcaptcha")
    public AjaxResult getCaptcha(){
        // 1.生成验证码到本地
        //定义图形验证码的长和宽
        LineCaptcha lineCaptcha = CaptchaUtil.createLineCaptcha(128, 50);
        String uuid = UUID.randomUUID().toString().replace("-","");
        // 图形验证码写出，可以写出到文件，也可以写出到流
        lineCaptcha.write(imagepath+uuid+".png");
        // url 地址
        String url = "/image/"+uuid+".png";
        // 将验证码存储到 redis
        redisTemplate.opsForValue().set(uuid,lineCaptcha.getCode());
        HashMap<String,String> result = new HashMap<>();
        result.put("codeurl",url);
        result.put("codekey",uuid);
        return AjaxResult.succ(result);
    }

}

```

![在这里插入图片描述](https://gitee.com/zdawdaw/img/raw/master/202408281932878.png)

![在这里插入图片描述](https://gitee.com/zdawdaw/img/raw/master/202408281932879.png)
### 1. 引入huto
![在这里插入图片描述](https://gitee.com/zdawdaw/img/raw/master/202408281932880.png)

### 2. controller

```java
package com.example.myblog.controller;

import cn.hutool.captcha.CaptchaUtil;
import cn.hutool.captcha.LineCaptcha;
import com.example.myblog.util.AjaxResult;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.HashMap;
import java.util.UUID;

/**
 * 验证码的控制器
 */
@RestController
public class CaptchaController {

    @Value("${imagepath}")
    private String imagepath;
    @Autowired
    private RedisTemplate redisTemplate;

    @RequestMapping("/getcaptcha")
    public AjaxResult getCaptcha(){
        // 1.生成验证码到本地
        //定义图形验证码的长和宽
        LineCaptcha lineCaptcha = CaptchaUtil.createLineCaptcha(128, 50);
        String uuid = UUID.randomUUID().toString().replace("-","");
        // 图形验证码写出，可以写出到文件，也可以写出到流
        lineCaptcha.write(imagepath+uuid+".png");
        // url 地址
        String url = "/image/"+uuid+".png";
        // 将验证码存储到 redis
        redisTemplate.opsForValue().set(uuid,lineCaptcha.getCode());
        HashMap<String,String> result = new HashMap<>();
        result.put("codeurl",url);
        result.put("codekey",uuid);
        return AjaxResult.succ(result);
    }

}

```
### 3. 在拦截器中不拦截验证码，并且设置映射地址

```java
/**
 * 映射图片路径
 * @param registry
 */
@Override
public void addResourceHandlers(ResourceHandlerRegistry registry) {
    registry.addResourceHandler("/image/**").addResourceLocations("file:" + imagepath);
}
```
### 4. 前端获取验证码

```js
    // 验证码key
    var codeKey = "";

    // 获取并显示验证码
    function loadCode() {
        jQuery.ajax({
            url: "/getcaptcha",
            type: "GET",
            data: {},
            success: function (res) {
                if (res.code = 200 && res.data != null && res.data != "") {
                    // 获取验证码成功
                    codeKey = res.data.codekey;
                    jQuery("#codeimg").attr("src", res.data.codeurl);
                }
            }
        });
    }

    loadCode();

```
### 5. 后端判断验证码是否有效

```java
        // redis 里面 key 对应的真是的验证码
        String redisCodeValue = (String) redisTemplate.opsForValue().get(userInfoVO.getCodeKey());
        if (!StringUtils.hasLength(redisCodeValue) || !redisCodeValue.equals(userInfoVO.getCheckCode())) {
            // 验证码不正确
            return AjaxResult.fail(-1, "验证码错误");
        }
        // 清除 redis 中的验证码
        redisTemplate.opsForValue().set(userInfoVO.getCodeKey(), "");
```
## 十三、文章详情页



#### 2. 实现MP

```java
package com.example.myblog.dao;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.example.myblog.model.CommentInfo;
import com.example.myblog.model.vo.CommentInfoVO;
import org.apache.ibatis.annotations.Param;

import java.util.List;

public interface CommentInfoMapper extends BaseMapper<CommentInfo> {
    List<CommentInfoVO> getList(@Param("aid")Integer aid);
}
```

```java
package com.example.myblog.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.example.myblog.dao.CommentInfoMapper;
import com.example.myblog.model.CommentInfo;
import com.example.myblog.model.vo.CommentInfoVO;
import com.example.myblog.service.ICommentInfoService;
import jakarta.annotation.Resource;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class CommentInfoServiceImpl extends ServiceImpl<CommentInfoMapper, CommentInfo> implements ICommentInfoService  {

    @Resource
    private CommentInfoMapper commentInfoMapper;

    @Override
    public List<CommentInfoVO> getList(Integer aid) {
        return commentInfoMapper.getList(aid);
    }
}

```

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.myblog.dao.CommentInfoMapper">

    <select id="getList" resultType="com.example.myblog.model.vo.CommentInfoVO">
        SELECT c.*,u.nickname from commentinfo c
            left join userinfo u on c.uid=u.uid
            where aid=#{aid}
            order by cid desc
    </select>

</mapper>
```
#### 3. 后端实现对文章评论的返回

```java
    /**
     * 查询某篇文章下的所有评论
     *
     * @param aid
     * @return
     */
    @RequestMapping("/list")
    public AjaxResult getList(Integer aid) {
        // 1.参数效验
        if (aid == null && aid <= 0) {
            return AjaxResult.fail(-1, "参数有误！");
        }
        // 2.查询数据库
        List<CommentInfoVO> list = commentInfoService.getList(aid);
        // 3.将结果返回给前端
        return AjaxResult.succ(list);
    }

```
#### 4. 前端-加载评论列表

```js
    // 加载评论列表
    function initComment() {
        jQuery.ajax({
            url: "/comment/list",
            type: "GET",
            data: {
                "aid": aid
            },
            success: function (res) {
                if (res.code == 200 && res.data != null) {
                    var commentListHtml = "";
                    for (let i = 0; i < res.data.length; i++) {
                        var comment = res.data[i];
                        commentListHtml += '<div style="margin-bottom: 26px;">';
                        commentListHtml += comment.nickname + '：' + comment.content;
                        commentListHtml += '<br>';
                        commentListHtml += '<a class="comment_del_class" style="display: none;" href="javascript:del(' +
                            comment.cid + ')">删除</a>';
                        commentListHtml += '</div>';
                    }
                    jQuery("#commentlist").html(commentListHtml);
                }
            }
        });
    }

```
### 文章详情页(3)阅读量加1
#### 1. mapper

```java
public interface ArticleInfoMapper extends BaseMapper<ArticleInfo> {
    ArticleInfoVO getDetail(@Param("aid")Integer aid);

    int updateRCount(@Param("aid")Integer aid);
}

```
#### 2. mapper.xml

```xml
    <update id="updateRCount">
        update articleinfo set rcount=rcount+1
        where aid=#{aid}
    </update>

```
#### 3. service

```java
package com.example.myblog.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.example.myblog.dao.ArticleInfoMapper;
import com.example.myblog.model.ArticleInfo;
import com.example.myblog.model.vo.ArticleInfoVO;
import com.example.myblog.service.IArticleInfoService;
import jakarta.annotation.Resource;
import org.springframework.stereotype.Service;

@Service
public class ArticleInfoServiceImpl extends ServiceImpl<ArticleInfoMapper, ArticleInfo> implements IArticleInfoService {

    @Resource
    private ArticleInfoMapper articleInfoMapper;

    @Override
    public ArticleInfoVO getDetail(Integer aid) {
        return articleInfoMapper.getDetail(aid);
    }

    @Override
    public int updateRCount(Integer aid) {
        return articleInfoMapper.updateRCount(aid);
    }
}

```

```java
package com.example.myblog.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.example.myblog.model.ArticleInfo;
import com.example.myblog.model.vo.ArticleInfoVO;

public interface IArticleInfoService extends IService<ArticleInfo> {
    ArticleInfoVO getDetail(Integer aid);

    int updateRCount(Integer aid);
}

```
#### 4. ArticleController

```java
    /**
     * 阅读量 +1
     *
     * @param aid
     * @return
     */
    @RequestMapping("/update_rcount")
    public AjaxResult updateRCount(Integer aid) {
        // 1.参数效验
        if (aid == null || aid <= 0) {
            return AjaxResult.fail(-1, "参数有误！");
        }
        // 2.修改数据库
        int result = articleInfoService.updateRCount(aid);
        // 3.将结果返回给前端
        return AjaxResult.succ(result);
    }
```
#### 5. 前端

```java    // 更新访问量
    function updateCount() {
        jQuery.ajax({
            url: "/art/update_rcount",
            type: "POST",
            data: {
                "aid": aid
            },
            success: function (res) {
            }
        });
    }

```
### 文章详情页(4)评论删除按钮展示
#### 1. 判断当前文章是否属于当前登录用户（然后判断删除是否显示）

```js
    // 判断当前文章是否属于当前登录用户
    function isArtByMe(aid) {
        jQuery.ajax({
            url: "/user/isartbyme",
            type: "GET",
            data: {
                "aid": aid
            },
            success: function (res) {
                if (res.code == 200 && res.data == 1) {
                    // 当前文章归属于当前登录用户
                    jQuery(".comment_del_class").each(function (i) {
                        jQuery(this).show();
                    });
                }
            }
        });
    }
```

#### 2. 获取当前登录的用户

```java    
// 获取当前登录的用户
    function getSessUser() {
        jQuery.ajax({
            url: "/user/getsess",
            type: "GET",
            data: {},
            success: function (res) {
                if (res.code == 200 && res.data != null && res.data.uid >= 0) {
                    // 当前用户已经登录
                    islogin = true;
                    jQuery("#comment_login_name").html(res.data.nickname);
                    // 判断当前文章是否是当前登录用户发表的
                    isArtByMe(aid);
                } else {
                    // 当前用户未登录
                }
            }
        });
    }

```
#### 3. 后端判断当前文章是否属于当前登录用户 || 并且获取当前登录用户

```java    
@RequestMapping("/getsess")
    public AjaxResult getSess(HttpServletRequest request) {
        UserInfo userInfo = SessionUtil.getUserInfo(request);
        if (userInfo == null || userInfo.getUid() <= 0) {
            return AjaxResult.fail(-2, "当前用户未登录！");
        }
        return AjaxResult.succ(userInfo);
    }

    /**
     * 查询当前文章是否属于当前登录用户
     */
    @RequestMapping("/isartbyme")
    public AjaxResult isArtByMe(Integer aid, HttpServletRequest request) {
        if (aid == null || aid <= 0) {
            return AjaxResult.fail(-1, "参数有误！");
        }
        UserInfo userInfo = SessionUtil.getUserInfo(request);
        if (userInfo == null || userInfo.getUid() <= 0) {
            return AjaxResult.fail(-2, "当前用户未登录！");
        }
        ArticleInfo articleInfo = articleInfoService.getById(aid);
        if (articleInfo != null && articleInfo.getAid() >= 0
                && articleInfo.getUid() == userInfo.getUid()) {
            // 文章是当前登录用户的
            return AjaxResult.succ(1);
        }
        return AjaxResult.succ(0);
    }


```
# 十四、添加和删除评论

### 1. 前端

```js
    // 添加评论
    function addComment() {
        // 评论正文
        var comment_content = jQuery("#comment_content");
        // 1.非空效验
        if (comment_content.val().trim() == "") {
            alert("请先输入评论的内容！");
            comment_content.focus();
            return false;
        }
        // 2.登录判断
        if (!islogin) {
            alert("请先登录！");
            return false;
        }
        // 3.将前端的数据发送给后端
        //    3.1 文章id
        //    3.2 评论内容
        jQuery.ajax({
            url: "/comment/add",
            type: "POST",
            data: {
                "aid": aid,
                "content": comment_content.val()
            },
            success: function (res) {
                // 4.将后端返回的数据显示给用户
                if (res.code == 200 && res.data == 1) {
                    // 评论添加成功
                    alert("恭喜：评论发表成功！");
                    // 刷新评论（刷新当前页面）
                    location.href = location.href;
                } else {
                    alert("抱歉：评论发表失败，请重试！" + res.msg);
                }
            }
        });
    }

```

```js
    // 评论的删除功能
    function del(cid) {
        if (!confirm("确定删除")) {
            return false;
        }
        // 1.效验参数
        if (cid == "" || cid <= 0) {
            alert("抱歉：操作失败，请刷新页面之后重试！");
            return false;
        }
        if (aid == "" || aid <= 0) {
            alert("抱歉：评论删除失败，请刷新页面之后重试！");
            return false;
        }
        // 2.发送数据给后端[评论id（cid）|文章id（aid）]
        jQuery.ajax({
            url: "/comment/del",
            type: "POST",
            data: {
                "cid": cid,
                "aid": aid
            },
            success: function (res) {
                // 3.将后端结果展现给用户
                if (res.code == 200 && res.data == 1) {
                    // 删除成功
                    alert("恭喜：评论删除成功！");
                    location.href = location.href;
                } else {
                    // 评论删除失败
                    alert("抱歉：评论删除失败！" + res.msg);
                }
            }
        });
    }
```

### 2. 后端

```java
    @RequestMapping("/add")
    public AjaxResult add(Long aid, String content, HttpServletRequest request) {
        // 1.参数效验
        if (aid == null || aid <= 0 || !StringUtils.hasLength(content)) {
            // 非法参数
            return AjaxResult.fail(-1, "非法参数");
        }
        // 2.组装数据（将 uid 从 session 中获取出来）
        UserInfo userInfo = SessionUtil.getUserInfo(request);
        if (userInfo == null || userInfo.getUid() <= 0) {
            // 用户登录有问题
            return AjaxResult.fail(-2, "请先登录！");
        }
        CommentInfo commentInfo = new CommentInfo();
        commentInfo.setAid(aid);
        commentInfo.setUid(userInfo.getUid());
        commentInfo.setContent(content);
        // 3.将评论对象插入到数据库
        boolean result = commentInfoService.save(commentInfo);
        // 4.将数据库执行的结果返回给前端
        return AjaxResult.succ(result ? 1 : 0);
    }

```

```java
    @RequestMapping("/del")
    public AjaxResult del(Long cid, Long aid, HttpServletRequest request) {
        // 1.参数效验
        if (cid == null || cid <= 0 || aid == null || aid <= 0) {
            return AjaxResult.fail(-1, "非法参数！");
        }
        // 2.效验权限（判断当前的文章是否属于当前登录用户）
        // 2.1 从 session 获取到用户 id
        UserInfo userInfo = SessionUtil.getUserInfo(request);
        if (userInfo == null || userInfo.getUid() <= 0) {
            // 无效登录用户
            return AjaxResult.fail(-2, "请先登录！");
        }
        // 2.2 从文章中获取到用户 id
        ArticleInfo articleInfo = articleInfoService.getById(aid);
        if (articleInfo == null || articleInfo.getAid() <= 0) {
            return AjaxResult.fail(-3, "非法的文章id");
        }
        // 2.3 判断文章uid是否等于session uid
        //   如果相等，说明当前文章属于当前登录用户，可以进行删除操作
        //   否则是不能进行删除操作的
        if (userInfo.getUid() != articleInfo.getUid()) {
            return AjaxResult.fail(-4, "非法操作！");
        }
        // 3.删除文章（操作数据库）
        boolean result = commentInfoService.removeById(cid);
        // 4.将结果返回给前端
        return AjaxResult.succ(result ? 1 : 0);
    }

```
# 十五、个人中心

### 个人中心-1（修改头像）
#### 1. 前端

```js
    // 获取用户头像和昵称
    function initPage() {
        jQuery.ajax({
            url: "/user/getsess",
            type: "GET",
            data: {},
            success: function (res) {
                if (res.code == 200 && res.data != null && res.data.uid >= 0) {
                    // 得到当前的登录用户
                    var userinfo = res.data;
                    if (null != userinfo.photo && userinfo.photo != "") {
                        jQuery("#photo").attr("src", userinfo.photo);
                    }
                    jQuery("#nickname").val(userinfo.nickname);
                } else {
                    alert("抱歉：查询用户信息出错，请刷新页面再试！" + res.msg);
                }
            }
        });
    }

    initPage();

    // 保存头像
    function savePhoto() {
        // 得到图片
        var photo = jQuery("#file")[0].files[0];
        if (photo == null) {
            alert("请先选择要上传的头像！");
            return false;
        }
        // 构建一个 form 表单
        var formData = new FormData();
        formData.append("file", photo);
        jQuery.ajax({
            url: "/user/save_photo",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function (res) {
                if (res.code == 200 && res.data != null && res.data != "") {
                    // 图片上传成功
                    jQuery("#photo").attr("src", res.data);
                } else {
                    // 图片上传失败
                    alert("抱歉：上传图片失败，请重试！" + res.msg);
                }
            }
        });
    }

```
#### 2. 后端

```java
    @RequestMapping("/save_photo")
    public AjaxResult savePhoto(MultipartFile file, HttpServletRequest request) {
        // 1.保存图片到服务器
        // 得到图片的后缀
        String imageType = file.getOriginalFilename().
                substring(file.getOriginalFilename().lastIndexOf("."));
        // 生成图片的名称
        String imgName = UUID.randomUUID().toString()
                .replace("-", "") + imageType;
        try {
            file.transferTo(new File(imagePath + imgName));
        } catch (IOException e) {
            return AjaxResult.fail(-1, "图片上传失败！");
        }
        String imgUrl = "/image/" + imgName;
        // 2.将图片地址保存到数据库
        UserInfo userInfo = SessionUtil.getUserInfo(request);
        if (userInfo == null || userInfo.getUid() <= 0) {
            // 未登录
            return AjaxResult.fail(-2, "请先登录！");
        }
        UpdateWrapper<UserInfo> wrapper = new UpdateWrapper<>();
        wrapper.set(true, "photo", imgUrl);
        wrapper.eq("uid", userInfo.getUid());
        boolean result = userService.update(wrapper);
        if (result) {
            // 图片保存成功
            // 更新头像到 session 中
            userInfo.setPhoto(imgUrl);
            HttpSession session = request.getSession();
            session.setAttribute(AppVar.SESSION_KEY_USERINFO, userInfo);
            return AjaxResult.succ(imgUrl);
        } else {
            return AjaxResult.fail(-3, "数据库修改失败");
        }
    }

```
### 修改昵称和密码
#### 1. 前端

```js
    // 修改昵称或修改密码
    function updateUser() {
        var isUpdatePassword = false; // 是否修改密码
        // 1.非空效验
        var nickname = jQuery("#nickname");
        var oldPassword = jQuery("#old_password");
        var password = jQuery("#password");
        var password2 = jQuery("#password2");
        if (nickname.val().trim() == "") {
            alert("请先输入昵称！");
            nickname.focus();
            return false;
        }
        if (oldPassword.val() != "" ||
            password.val() != "" || password2.val() != "") {
            // 需要修改密码
            isUpdatePassword = true;
            if (oldPassword.val().trim() == "") {
                alert("请先输入原密码！");
                oldPassword.focus();
                return false;
            }
            if (password.val().trim() == "") {
                alert("请先输入新密码！");
                password.focus();
                return false;
            }
            if (password2.val().trim() == "") {
                alert("请先输入确认密码！");
                password2.focus();
                return false;
            }
            // 判断新密码和确认密码是否一致
            if (password.val() != password2.val()) {
                alert("两次输入的新密码不一致，请先确认！");
                return false;
            }
        }
        // 2.将前端的数据提交给后端
        jQuery.ajax({
            url: "/user/update",
            type: "POST",
            data: {
                "nickname": nickname.val(),
                "oldpassword": oldPassword.val(),
                "password": password.val(),
                "isUpdatePassword": isUpdatePassword
            },
            success: function (res) {
                // 3.将返回的结果展现给用户
                if (res.code == 200 && res.data == 1) {
                    // 修改成功
                    if (isUpdatePassword) {
                        alert("恭喜：修改成功，请重新登录！");
                        // 修改密码，重新登录
                        location.href = "login.html";
                    } else {
                        alert("恭喜：昵称修改成功！");
                    }
                } else {
                    // 修改失败
                    alert("抱歉：修改失败，请重试！" + res.msg);
                }
            }
        });
    }

```
#### 2. 后端

```java
    /**
     * 个人中心修改昵称或密码
     *
     * @param nickname
     * @param oldpassword
     * @param password
     * @param isUpdatePassword
     * @return
     */
    @RequestMapping("/update")
    public AjaxResult update(String nickname, String oldpassword,
                             String password, Boolean isUpdatePassword,
                             HttpServletRequest request) {
        // 1.参数效验
        if (!StringUtils.hasLength(nickname)) {
            return AjaxResult.fail(-1, "非法参数！");
        }
        // 是否要修改密码
        if (isUpdatePassword) {
            // 修改原密码
            if (!StringUtils.hasLength(oldpassword) || !StringUtils.hasLength(password)) {
                return AjaxResult.fail(-1, "非法参数！");
            }
        }
        // 2.组装数据（从 Session 获取用户信息）
        UserInfo userInfo = SessionUtil.getUserInfo(request);
        if (userInfo == null || userInfo.getUid() <= 0) {
            return AjaxResult.fail(-2, "请先登录！");
        }
        userInfo.setNickname(nickname);
        UpdateWrapper<UserInfo> updateWrapper = new UpdateWrapper<>();
        // 判断是否修改密码，如果修改密码，则需要验证用户输入的原密码是否正确
        if (isUpdatePassword) {
            UserInfo dbUser = userService.getById(userInfo.getUid());
            // 需要修改密码，验证原密码是否正确
            boolean checkPassword = PasswordUtil.decrypt(oldpassword, dbUser.getPassword());
            if (!checkPassword) {
                return AjaxResult.fail(-3, "原密码输入错误！");
            }
            // 修改密码
            password = PasswordUtil.encrypt(password); // 加盐之后的密码
            updateWrapper.set("password", password);
        }
        // 3.修改数据库
        updateWrapper.eq("uid", userInfo.getUid());
        updateWrapper.set("nickname", nickname);
        boolean result = userService.update(updateWrapper);
        // 4.将结果返回给前端
        return AjaxResult.succ(result ? 1 : 0);
    }
```
# 十六、我的列表页

### 1. 查询所有文章

## 十七、并发编程

### 1.  线程池的创建

